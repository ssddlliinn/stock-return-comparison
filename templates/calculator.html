<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>財務計算機</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 30px;
        }
        .calculator-section {
            margin-bottom: 40px;
        }
        .formula {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2em;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .formula-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            margin: 0 5px;
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        /* 決定年金左邊的標籤的寬度 */
        .input-group label {
            width: 30%;
            text-align: center;
            font-weight: bold;
            padding-right: 10px;
        }
        .input-group .input-wrapper {
            width: 45%;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }
        .table-container {
            margin-top: 30px;
        }
        .growth-table {
            width: 100%;
            border-collapse: collapse;
        }
        .growth-table th, .growth-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }
        .growth-table th {
            background-color: #e9ecef;
        }
        .growth-table .hidden {
            background-color: #ccc;
            cursor: pointer;
            color: transparent;
        }
        .growth-table .hidden:hover {
            background-color: #adb5bd;
        }
        .btn-formula-calculate {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }
        .btn-calculate {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-left: 25px;
        }
        .btn-calculate:hover {
            background-color: #0056b3;
        }
        .formula-input-group {
            /* display: flex; */
            justify-content: space-between;
            align-items: center;
            gap: 5px; /* 調整間距 */
        }
        .formula-input-group .formula-input {
            width: 12.5%; /* 調整寬度 */
            /* flex-grow: 1; */
        }
        .formula-input-group span {
            flex-shrink: 0;
        }
        .annuity-section-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            /* gap: 20px; */
        }
        .annuity-input-wrapper {
            flex: 0 0 60%;
            flex-direction: row;
            gap: 10px;
        }
        .explanation-box {
            flex: 0 0 40%;
            padding: 15px;
            background-color: #383F54; /* 背景色改為淺灰色 */
            border-radius: 4px;
            font-size: 1em;
            line-height: 1.6;
            position: relative; /* 設定為相對定位 */
            min-height: 250px; /* 設置最小高度以容納圖片 */
        }

        .speech-bubble {
            position: relative;
            background: transparent;
            border-radius: .4em;
            /* padding: 15px; */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: left;
            margin-bottom: 90px; /* 為圖片預留空間 */
            z-index: 2;
        }
        
        /* .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            right: 25px; 
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 15px 15px 0 15px;
            border-color: #fff transparent transparent transparent;
        } */
        
        .character-container {
            position: absolute; /* 絕對定位 */
            bottom: 15px; /* 距離底部邊緣 */
            right: 15px; /* 距離右側邊緣 */
            width: 150px;
            height: 150px;
            z-index: 1;
        }

        .character-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>財務計算機</h1>
        
        <!-- 複利現值與未來值計算 -->
        <div class="calculator-section">
            <h2>現值未來值複利公式</h2>
            <div class="formula">
                未來值(FV)   =   現值(PV) * (1 + 報酬率(rate)) ^ 期數(n)
            </div>
            <div class="formula-input-group">
                <input type="text" id="fv" class="formula-input" onblur="formatNumberInput(this)">
                <span>=</span>
                <input type="text" id="pv" class="formula-input" onblur="formatNumberInput(this)">
                <span>* (1 +</span>
                <input type="text" id="rate" class="formula-input" onblur="formatNumberInput(this)">
                <span>%) ^</span>
                <input type="text" id="n" class="formula-input" onblur="formatNumberInput(this)">
                <span>年</span>
            </div>
            <button class="btn-formula-calculate" onclick="calculateCompound()">計算</button>
        </div>

        <!-- 年金複利公式 -->
        <div class="calculator-section">
            <h2>年金複利公式</h2>
            <div class="annuity-section-content">
                <div class="annuity-input-wrapper">
                    <div class="input-group">
                        <label for="pv_annuity">現值 (PV):</label>
                        <div class="input-wrapper"><input type="text" id="pv_annuity" onblur="formatNumberInput(this)"></div>
                        <button class="btn-calculate" onclick="calculateAnnuity('pv_annuity')">計算</button>
                    </div>
                    <div class="input-group">
                        <label for="fv_annuity">未來值 (FV):</label>
                        <div class="input-wrapper"><input type="text" id="fv_annuity" onblur="formatNumberInput(this)"></div>
                        <button class="btn-calculate" onclick="calculateAnnuity('fv_annuity')">計算</button>
                    </div>
                    <div class="input-group">
                        <label for="pmt">年金 (PMT):</label>
                        <div class="input-wrapper"><input type="text" id="pmt" value="10,000" onblur="formatNumberInput(this)"></div>
                        <button class="btn-calculate" onclick="calculateAnnuity('pmt')">計算</button>
                    </div>
                    <div class="input-group">
                        <label for="rate_annuity">報酬率 (%):</label>
                        <div class="input-wrapper"><input type="text" id="rate_annuity" value="12" onblur="formatNumberInput(this)"></div>
                        <button class="btn-calculate" onclick="calculateAnnuity('rate_annuity')">計算</button>
                    </div>
                    <div class="input-group">
                        <label for="n_annuity">期數 (年):</label>
                        <div class="input-wrapper"><input type="text" id="n_annuity" value="10" onblur="formatNumberInput(this)"></div>
                        <button class="btn-calculate" onclick="calculateAnnuity('n_annuity')">計算</button>
                    </div>
                </div>
                <div id="annuity-explanation" class="explanation-box">
                    <div id="explanation-text" class="speech-bubble" style="display: none;">
                        <!-- 解釋文字會顯示在這裡 -->
                    </div>
                    <div class="character-container">
                        <img src="./static/character.png" alt="人物" class="character-img">
                    </div>
                </div>
            </div>
        </div>

        <!-- 複利成長表格 -->
        <div class="table-container">
            <h2>本金10萬美元的複利成長</h2>
            <p>點擊數字以顯示隱藏的 30 年期資料。</p>
            <table class="growth-table">
                <thead>
                    <tr>
                        <th>投資年數</th>
                        <th>4%</th>
                        <th>8%</th>
                        <th>12%</th>
                        <th>16%</th>
                    </tr>
                </thead>
                <tbody id="growth-table-body">
                    <!-- 表格內容將由 JavaScript 動態生成 -->
                </tbody>
            </table>
        </div>
        
    </div>

    <script>
        const API_BASE_URL = '/';

        function formatNumberInput(inputElement) {
            // 格式化數字
            const num = parseFloat(inputElement.value.replace(/,/g, ''));
            if (!isNaN(num)) {
                inputElement.value = num.toLocaleString('en-US');
            } else {
                inputElement.value = '';
            }
        }

        function calculateCompound() {
            const inputs = {
                'fv': parseFloat(document.getElementById('fv').value.replace(/,/g, '')),
                'pv': parseFloat(document.getElementById('pv').value.replace(/,/g, '')),
                'rate': parseFloat(document.getElementById('rate').value.replace(/,/g, '')) / 100, // 轉換為小數
                'n': parseFloat(document.getElementById('n').value.replace(/,/g, ''))
            };
            
            const filledCount = Object.values(inputs).filter(v => !isNaN(v)).length;
            
            if (filledCount !== 3) {
                alert('請輸入三個變數來計算第四個。');
                return;
            }
            
            // 找出未填寫的變數
            const unknownVar = Object.keys(inputs).find(key => isNaN(inputs[key]));
            
            fetch(API_BASE_URL + 'calculate_compound', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inputs)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // 根據未知變數填入計算結果
                if (unknownVar === 'fv') document.getElementById('fv').value = data.fv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                if (unknownVar === 'pv') document.getElementById('pv').value = data.pv.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                if (unknownVar === 'rate') document.getElementById('rate').value = (data.rate * 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                if (unknownVar === 'n') document.getElementById('n').value = data.n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            });
        }
        
        function calculateAnnuity(target_output) {
            const inputs = {
                'pv_annuity': parseFloat(document.getElementById('pv_annuity').value.replace(/,/g, '')),
                'fv_annuity': parseFloat(document.getElementById('fv_annuity').value.replace(/,/g, '')),
                'pmt': parseFloat(document.getElementById('pmt').value.replace(/,/g, '')),
                'rate_annuity': parseFloat(document.getElementById('rate_annuity').value.replace(/,/g, '')) / 100,
                'n_annuity': parseFloat(document.getElementById('n_annuity').value.replace(/,/g, ''))
            };
            
            const filledCount = Object.values(inputs).filter(v => !isNaN(v)).length;
            if (filledCount < 3) {
                alert('請輸入至少三個變數來計算。');
                return;
            }

            inputs['target_output'] = target_output;
            
            fetch(API_BASE_URL + 'calculate_annuity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(inputs)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                if (target_output === 'pv_annuity') document.getElementById('pv_annuity').value = data.pv_annuity.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                if (target_output === 'fv_annuity') document.getElementById('fv_annuity').value = data.fv_annuity.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                if (target_output === 'pmt') document.getElementById('pmt').value = data.pmt.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                if (target_output === 'rate_annuity') document.getElementById('rate_annuity').value = (data.rate_annuity * 100).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                if (target_output === 'n_annuity') document.getElementById('n_annuity').value = data.n_annuity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
                // 在這裡生成並顯示白話解釋
                let explanationText = "";
                const numFormatter = new Intl.NumberFormat('en-US');
                if (target_output === 'pv_annuity') {
                    explanationText = `這筆年金的現值為 ${numFormatter.format(data.pv_annuity.toFixed(0))}。這代表如果您現在需要一次性領取這筆錢，可以領到這麼多。`;
                } else if (target_output === 'fv_annuity') {
                    explanationText = `這筆年金在未來將累積至 ${numFormatter.format(data.fv_annuity.toFixed(0))} 的價值。這是您在期滿後可以領取的總金額。`;
                } else if (target_output === 'pmt') {
                    explanationText = `為了達到目標，您每年需要投入 ${numFormatter.format(data.pmt.toFixed(0))}。這是您每年必須存入的金額。`;
                } else if (target_output === 'rate_annuity') {
                    explanationText = `您的年金報酬率為 ${(data.rate_annuity * 100).toFixed(2)}%。這是在這個期間內每年獲得的平均報酬。`;
                } else if (target_output === 'n_annuity') {
                    explanationText = `達到目標需要 ${data.n_annuity.toFixed(0)} 年。這是您需要持續投資的總年限。`;
                }

                const explanationBox = document.getElementById('explanation-text');
                explanationBox.textContent = explanationText;
                explanationBox.style.display = 'flex';
            });
        }
        
        function fetchGrowthTable() {
            const initialCapital = 100000;
            fetch(API_BASE_URL + 'calculate_table', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ initial_capital: initialCapital })
            })
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('growth-table-body');
                const years = [10, 20, 30];
                tableBody.innerHTML = ''; // 清空舊內容
                data.results.forEach((row, rowIndex) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${years[rowIndex]}年</td>`;
                    row.forEach((value, colIndex) => {
                        const td = document.createElement('td');
                        td.textContent = value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                        if (years[rowIndex] === 30) {
                            td.className = 'hidden';
                            td.onclick = function() {
                                this.className = '';
                                this.style.cursor = 'default';
                            };
                        }
                        tr.appendChild(td);
                    });
                    tableBody.appendChild(tr);
                });
            });
        }
        
        window.onload = fetchGrowthTable;
    </script>
</body>
</html>
